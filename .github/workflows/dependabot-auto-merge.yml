name: Dependabot Auto-Merge

on:
  # è§¦å‘æ¡ä»¶ï¼šé’ˆå¯¹æ‰€æœ‰åˆ†æ”¯çš„ pull_request äº‹ä»¶
  # pull_request_target æ›´å®‰å…¨ï¼Œå› ä¸ºå®ƒåœ¨ç›®æ ‡ä»“åº“çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œå¯ä»¥è®¿é—® secrets
  # ä½†ä½¿ç”¨ pull_request_target æ—¶è¦éå¸¸å°å¿ƒï¼Œç¡®ä¿ä½ åªæ“ä½œå¯ä¿¡çš„ PRï¼ˆä¾‹å¦‚æ£€æŸ¥ PR ä½œè€…ï¼‰
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  # éœ€è¦è¿™äº›æƒé™æ¥æ£€æŸ¥ PR çŠ¶æ€ã€æ·»åŠ æ ‡ç­¾ã€åˆå¹¶ PR å’Œå†™å…¥å†…å®¹ï¼ˆä¾‹å¦‚æ›´æ–° PR ä½“ï¼‰
  pull-requests: write
  contents: write # å¦‚æœéœ€è¦ä¿®æ”¹ PR ä½“æˆ–æäº¤çŠ¶æ€
  statuses: write # å†™å…¥æäº¤çŠ¶æ€ (å¯é€‰)

jobs:
  auto-merge:
    # åªé’ˆå¯¹ Dependabot åˆ›å»ºçš„ PR è¿è¡Œæ­¤ä½œä¸š
    if: github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR metadata (not the code itself initially for pull_request_target)
        # å¯¹äº pull_request_targetï¼Œactions/checkout é»˜è®¤ä¼šæ£€å‡ºåŸºç¡€åˆ†æ”¯
        # æˆ‘ä»¬è¿™é‡Œä¸»è¦éœ€è¦ PR çš„ä¿¡æ¯
        id: pr_info
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          # ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šæ£€æŸ¥ï¼Œä¾‹å¦‚æ£€æŸ¥ PR æ ‡é¢˜æ˜¯å¦åŒ…å« "patch" æˆ– "minor"ï¼ˆå¦‚æœä½ åªæƒ³è‡ªåŠ¨åˆå¹¶è¿™ä¸¤ç±»ï¼‰
          # æˆ–è€…æ£€æŸ¥ PR æ˜¯å¦æœ‰ç‰¹å®šçš„ Dependabot æ ‡ç­¾

      # æ­¥éª¤1ï¼šç­‰å¾…æ‰€æœ‰å¿…éœ€çš„çŠ¶æ€æ£€æŸ¥å®Œæˆå¹¶é€šè¿‡
      # æ³¨æ„ï¼šGitHub Actions æœ¬èº«æ²¡æœ‰ç›´æ¥çš„ "wait for all checks to pass" çš„æ­¥éª¤ã€‚
      # GitHub çš„è‡ªåŠ¨åˆå¹¶åŠŸèƒ½ (é€šè¿‡ API/gh CLI å¯ç”¨) ä¼šåœ¨æ‰€æœ‰å¿…éœ€æ£€æŸ¥é€šè¿‡åæ‰åˆå¹¶ã€‚
      # æ‰€ä»¥è¿™ä¸€æ­¥æ›´å¤šçš„æ˜¯é€»è¾‘ä¸Šçš„ï¼Œç¡®ä¿ä½ çš„åˆ†æ”¯ä¿æŠ¤è§„åˆ™é…ç½®æ­£ç¡®ã€‚

      # æ­¥éª¤2ï¼šå¦‚æœæ‰€æœ‰ CI æ£€æŸ¥éƒ½å·²åœ¨ PR ä¸Šä¸‹æ–‡ä¸­æˆåŠŸè¿è¡Œï¼ˆç”±å¦ä¸€ä¸ªå·¥ä½œæµæˆ–åŒä¸€å·¥ä½œæµçš„ä¸åŒä½œä¸šå®Œæˆï¼‰
      # å¹¶ä¸”ä½ å·²ç»é€šè¿‡ if æ¡ä»¶ç¡®è®¤äº†è¿™æ˜¯ Dependabot çš„ PRï¼Œå°±å¯ä»¥å°è¯•åˆå¹¶ã€‚

      - name: Enable Auto-Merge for Dependabot PR
        # ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„CIæ£€æŸ¥ï¼ˆä¾‹å¦‚ lint, test, buildï¼‰å·²ç»ä½œä¸ºå¿…éœ€çš„çŠ¶æ€æ£€æŸ¥é…ç½®åœ¨ä½ çš„åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­
        # åªæœ‰å½“è¿™äº›æ£€æŸ¥éƒ½é€šè¿‡åï¼ŒGitHub çš„è‡ªåŠ¨åˆå¹¶æ‰ä¼šçœŸæ­£æ‰§è¡Œ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨å†…ç½®çš„ GITHUB_TOKENï¼Œå®ƒæœ‰æƒé™æ“ä½œ PR
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "Attempting to enable auto-merge for PR: $PR_URL by ${{ env.PR_AUTHOR }}"
          # ä½¿ç”¨ GitHub CLI å¯ç”¨è‡ªåŠ¨åˆå¹¶
          # ä½ å¯ä»¥é€‰æ‹©åˆå¹¶ç­–ç•¥ï¼š--merge, --squash, --rebase
          # --delete-branch ä¼šåœ¨åˆå¹¶ååˆ é™¤åˆ†æ”¯
          gh pr merge "$PR_URL" --auto --squash --delete-branch
          echo "Auto-merge enabled for PR: $PR_URL. GitHub will merge it when all required checks pass."

      # (å¯é€‰) æ·»åŠ è¯„è®ºåˆ° PRï¼Œå‘ŠçŸ¥å·²å¯ç”¨è‡ªåŠ¨åˆå¹¶
      - name: Add auto-merge comment to PR
        if: success() # ä»…åœ¨å¯ç”¨è‡ªåŠ¨åˆå¹¶æˆåŠŸå
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– Auto-merge has been enabled for this Dependabot PR. It will be merged automatically once all required status checks pass.'
            })